import pinyin from "pinyin";
import nodejieba from "nodejieba";
import MeCab from "mecab-async";

/** List of commonly used characters that is only used in Japanese */
const jaOnly = /[ãã‚ãƒã„ã…ã†ã‡ãˆã‰ãŠã‹ãŒããŽããã‘ã’ã“ã”ã•ã–ã—ã˜ã™ãšã›ãœããžãŸã ã¡ã¢ã£ã¤ã¥ã¦ã§ã¨ã©ãªã«ã¬ã­ã®ã¯ã°ã±ã²ã³ã´ãµã¶ã·ã¸ã¹ãºã»ã¼ã½ã¾ã¿ã‚€ã‚ã‚‚ã‚ƒã‚„ã‚…ã‚†ã‚‡ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚Žã‚ã‚ã‚‘ã‚’ã‚“ã‚”ã‚•ã‚–ã‚›ã‚œã‚ã‚žã‚Ÿã‚ ãƒ¼ï½°ð›€ð›€‚ð›€ƒð›€„ð›€…ð›€†ð›€‡ð›€ˆð›€‰ð›€Šð›€‹ð›€Œð›€ð›€Žð›€ð›€ð›€‘ð›€’ð›€“ð›€”ð›€•ð›€–ð›€—ð›€˜ð›€™ð›€šð›€›ð›€œð›€ð›€žð›€Ÿð›€ ð›€¡ð›€¢ð›€£ð›€¤ð›€¥ð›€¦ð›€§ð›€¨ð›€©ð›€ªð›€«ð›€¬ð›€­ð›€®ð›€¯ð›€°ð›€±ð›€²ð›€³ð›€´ð›€µð›€¶ð›€·ð›€¸ð›€¹ð›€ºð›€»ð›€¼ð›€½ð›€¾ð›€¿ð›€ð›ð›‚ð›ƒð›„ð›…ð›†ð›‡ð›ˆð›‰ð›Šð›‹ð›Œð›ð›Žð›ð›ð›‘ð›’ð›“ð›”ð›•ð›–ð›—ð›˜ð›™ð›šð››ð›œð›ð›žð›Ÿð› ð›¡ð›¢ð›£ð›¤ð›¥ð›¦ð›§ð›¨ð›©ð›ªð›«ð›¬ð›­ð›®ð›¯ð›°ð›±ð›²ð›³ð›´ð›µð›¶ð›·ð›¸ð›¹ð›ºð›»ð›¼ð›½ð›¾ð›¿ð›‚€ð›‚ð›‚‚ð›‚ƒð›‚„ð›‚…ð›‚†ð›‚‡ð›‚ˆð›‚‰ð›‚Šð›‚‹ð›‚Œð›‚ð›‚Žð›‚ð›‚ð›‚‘ð›‚’ð›‚“ð›‚”ð›‚•ð›‚–ð›‚—ð›‚˜ð›‚™ð›‚šð›‚›ð›‚œð›‚ð›‚žð›‚Ÿð›‚ ð›‚¡ð›‚¢ð›‚£ð›‚¤ð›‚¥ð›‚¦ð›‚§ð›‚¨ð›‚©ð›‚ªð›‚«ð›‚¬ð›‚­ð›‚®ð›‚¯ð›‚°ð›‚±ð›‚²ð›‚³ð›‚´ð›‚µð›‚¶ð›‚·ð›‚¸ð›‚¹ð›‚ºð›‚»ð›‚¼ð›‚½ð›‚¾ð›‚¿ð›ƒ€ð›ƒð›ƒ‚ð›ƒƒð›ƒ„ð›ƒ…ð›ƒ†ð›ƒ‡ð›ƒˆð›ƒ‰ð›ƒŠð›ƒ‹ð›ƒŒð›ƒð›ƒŽð›ƒð›ƒð›ƒ‘ð›ƒ’ð›ƒ“ð›ƒ”ð›ƒ•ð›ƒ–ð›ƒ—ð›ƒ˜ð›ƒ™ð›ƒšð›ƒ›ð›ƒœð›ƒð›ƒžð›ƒŸð›ƒ ð›ƒ¡ð›ƒ¢ð›ƒ£ð›ƒ¤ð›ƒ¥ð›ƒ¦ð›ƒ§ð›ƒ¨ð›ƒ©ð›ƒªð›ƒ«ð›ƒ¬ð›ƒ­ð›ƒ®ð›ƒ¯ð›ƒ°ð›ƒ±ð›ƒ²ð›ƒ³ð›ƒ´ð›ƒµð›ƒ¶ð›ƒ·ð›ƒ¸ð›ƒ¹ð›ƒºð›ƒ»ð›ƒ¼ð›ƒ½ð›ƒ¾ð›ƒ¿ð›„€ð›„ð›„‚ð›„ƒð›„„ð›„…ð›„†ð›„‡ð›„ˆð›„‰ð›„Šð›„‹ð›„Œð›„ð›„Žð›„ð›„ð›„‘ð›„’ð›„“ð›„”ð›„•ð›„–ð›„—ð›„˜ð›„™ð›„šð›„›ð›„œð›„ð›„žï¿½ï¿½ï¿½ðŸˆ€ã€±ã€²ã€³ã€´ã€µã‚›ã‚œã‚ ã‚¡ã‚¢ã‚£ã‚¤ã‚¥ã‚¦ã‚§ã‚¨ã‚©ã‚ªã‚«ã‚¬ã‚­ã‚®ã‚¯ã‚°ã‚±ã‚²ã‚³ã‚´ã‚µã‚¶ã‚·ã‚¸ã‚¹ã‚ºã‚»ã‚¼ã‚½ã‚¾ã‚¿ãƒ€ãƒãƒ‚ãƒƒãƒ„ãƒ…ãƒ†ãƒ‡ãƒˆãƒ‰ãƒŠãƒ‹ãƒŒãƒãƒŽãƒãƒãƒ‘ãƒ’ãƒ“ãƒ”ãƒ•ãƒ–ãƒ—ãƒ˜ãƒ™ãƒšãƒ›ãƒœãƒãƒžãƒŸãƒ ãƒ¡ãƒ¢ãƒ£ãƒ¤ãƒ¥ãƒ¦ãƒ§ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ®ãƒ¯ãƒ°ãƒ±ãƒ²ãƒ³ãƒ´ãƒµãƒ¶ãƒ·ãƒ¸ãƒ¹ãƒºãƒ»ãƒ¼ãƒ½ãƒ¾ãƒ¿ã‡°ã‡±ã‡²ã‡³ã‡´ã‡µã‡¶ã‡·ã‡¸ã‡¹ã‡ºã‡»ã‡¼ã‡½ã‡¾ã‡¿ã‹ã‹‘ã‹’ã‹“ã‹”ã‹•ã‹–ã‹—ã‹˜ã‹™ã‹šã‹›ã‹œã‹ã‹žã‹Ÿã‹ ã‹¡ã‹¢ã‹£ã‹¤ã‹¥ã‹¦ã‹§ã‹¨ã‹©ã‹ªã‹«ã‹¬ã‹­ã‹®ã‹¯ã‹°ã‹±ã‹²ã‹³ã‹´ã‹µã‹¶ã‹·ã‹¸ã‹¹ã‹ºã‹»ã‹¼ã‹½ã‹¾ï½¥ï½¦ï½§ï½¨ï½©ï½ªï½«ï½¬ï½­ï½®ï½¯ï½°ï½±ï½²ï½³ï½´ï½µï½¶ï½·ï½¸ï½¹ï½ºï½»ï½¼ï½½ï½¾ï½¿ï¾€ï¾ï¾‚ï¾ƒï¾„ï¾…ï¾†ï¾‡ï¾ˆï¾‰ï¾Šï¾‹ï¾Œï¾ï¾Žï¾ï¾ï¾‘ï¾’ï¾“ï¾”ï¾•ï¾–ï¾—ï¾˜ï¾™ï¾šï¾›ï¾œï¾ð›€€ï¿½ï¿½ï¿½ï¿½ãŒ€ãŒãŒ‚ãŒƒãŒ„ãŒ…ãŒ†ãŒ‡ãŒˆãŒ‰ãŒŠãŒ‹ãŒŒãŒãŒŽãŒãŒãŒ‘ãŒ’ãŒ“ãŒ”ãŒ•ãŒ–ãŒ—ãŒ˜ãŒ™ãŒšãŒ›ãŒœãŒãŒžãŒŸãŒ ãŒ¡ãŒ¢ãŒ£ãŒ¤ãŒ¥ãŒ¦ãŒ§ãŒ¨ãŒ©ãŒªãŒ«ãŒ¬ãŒ­ãŒ®ãŒ¯ãŒ°ãŒ±ãŒ²ãŒ³ãŒ´ãŒµãŒ¶ãŒ·ãŒ¸ãŒ¹ãŒºãŒ»ãŒ¼ãŒ½ãŒ¾ãŒ¿ã€ãã‚ãƒã„ã…ã†ã‡ãˆã‰ãŠã‹ãŒããŽããã‘ã’ã“ã”ã•ã–ã—ã»ã¼ã½ã¾ã¿å¢—æ¥½è–¬éœŠå¡¡çŠ æ¸“ï©Ÿé›‘ï©çŒŸæ§‡ï©æ „ç•³ï¨›è¾¼å¸°ï¤©é‰±ç£ç •å‘‰ï©©ï©‹æ—ï¨±ç¹Šç²‹ç€¬ï©™ï¨»åŽ³éš å¤‰é ¬å‰°æ‹ å‰¤æ–Žå°‚ï©Šå»ƒåŒ‚å·£è»¢é»’ï©Œèˆ—è”µä¼æ­©é‹³é¤ æ„¼é¨“æŠœèª­ï¨–ï¤¨éƒžæ›½ä»®é§…è­²ï¤é…”æ¡Ÿæ¸ˆæ°—æ–‰å›²æŠžçµŒä¹—æº€ï©”ï©¨éŒ¬ï¨·æˆ»é†¸ï¤¶å¯›éŠ­æ§˜æ­³æ¯Žå¥¨è‰¶å¸¯ï¨°æŒ™ï©§ï©šï¨¸ä¸¡é‡ˆï©–ï¨ºæŒ¿å¾“æ¨©ï¨¿å¬¢ï¨¦å€¹è±Šæˆ¦åºï©¢ï¨µæ­“é§†è¦³æºå¾´æ‚ªå¾³å£Œå›£ï©ƒå–¶å¨¯å¼¾æ¸‡æµï©‘ç¸æž ï¨´éš£å¯¾ï©‡ï©£æ¤œå½æ‘‚ï§ï©¡ç™ºç·–å£Šæ‹¡ç²›æŽ²æ¶™ç©ç·åœæ‹æ²¢ï©¥åœ§æµ„é¡”ä»å›³é™¥æ­´äº€å£±ï©„çœžï©ˆé—˜é«ªå††æ‰±å¡©é¨’æ‡è¦šï©è»½å³ æˆ¸é ¼è˜é»™æ™©ï¨¢ç¶™è›é…é€“ï¨šï©—å–©å¿œæ‚©å§«é™ºé½¢æ’ƒè´è¦§ç—©å€¤é‰„ï©’å¡€ç¶šï¨³ï©œé¶è¾ºç¸„ï¨½çµµéƒ·æœï©€ï©›é¬ªï©…å…å®Ÿè–«äºœï©†æ­¯é§„æ¸‹å¼åºƒå§‰å·»å‰£è¨¼å¡å˜é¡•ä¾¡ï©“ï©ï©•ç©‚æš¦æ‰•æ ƒè¨³æ¸‰çœŒåŠ´éººç³¸ç„¼å‹²ï¨™èˆŽç¸¦ï©¤é«„ä¸¼æšæ¡œæ»è„³ç¨²å‹§éŽ­ï©Žå£²]/;
/** Test the string if has Han characters */
const isHan = /[\u4E00-\u9FA5\u9FA6-\u9FEF\u3400-\u4DB5\u{20000}-\u{2A6D6}\u{2A700}-\u{2B734}\u{2B740}-\u{2B81D}\u{2B820}-\u{2CEA1}\u{2CEB0}-\u{2EBE0}\u2F00-\u2FD5\u2E80-\u2EF3\uF900-\uFAD9\u{2F800}-\u{2FA1D}\uE815-\uE86F\uE400-\uE5E8\uE600-\uE6CF\u31C0-\u31E3\u2FF0-\u2FFB\u3105-\u312F\u31A0-\u31BA\u3007]/u;

const mecab = new MeCab();
mecab.command = "mecab -d /usr/local/lib/mecab/dic/mecab-ipadic-neologd --node-format=\"%M\t%H\n\" --unk-format=\"%M\t%H\n\"";
mecab.parser = function (data) {
  return {
    kanji: data[0],
    lexical: data[1] || "",
    compound: data[2] || "",
    compound2: data[3] || "",
    compound3: data[4] || "",
    conjugation: data[5] || "",
    inflection: data[6] || "",
    original: data[7] || "",
    reading: data[8] || "",
    pronunciation: data[9] || ""
  };
};

/**
 * Convert katakana to hiragana.
 * @param str katakana
 */
function kanaToHira(str: string): string {
  return str.replace(/[\u30a1-\u30f6]/g,
    match => String.fromCharCode(match.charCodeAt(0) - 0x60)
  );
}

export function transliterate(text: string): string {
  if (jaOnly.test(text)) {
    // transliterate as ja
    const words = mecab.parseSyncFormat(text);
    return words.map(x => {
      if (jaOnly.test(x.kanji) || isHan.test(x.kanji)) {
        const prefix = x.kanji.substr(0, x.kanji.indexOf(x.original));
        return prefix + kanaToHira(x.reading || x.kanji);
      }
      return x.kanji;
    }).join("");
  } else if (isHan.test(text)) {
    // transliterate as zh
    const words: string[] = nodejieba.cut(text);
    return words.map(
      word => pinyin(word, { segment: true, heteronym: true }).map(x => x[0]).join("")
    ).join(" ");
  } else {
    // No asian text found
    return text;
  }
}
